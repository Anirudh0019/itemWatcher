{% extends "base.html" %}

{% block title %}{{ product.title }} - ItemWatcher{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
{% endblock %}

{% block content %}
<div>
    <a href="/" style="color: #667eea; text-decoration: none; margin-bottom: 20px; display: inline-block;">← Back to list</a>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">{{ product.title }}</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div>
            <div style="color: #666; font-size: 0.9rem;">Current Price</div>
            {% if latest_price %}
                <div class="price">₹{{ "{:,.0f}".format(latest_price.price) }}</div>
                {% if latest_price.in_stock %}
                    <span class="badge badge-success">✓ In Stock</span>
                {% else %}
                    <span class="badge badge-danger">✗ Out of Stock</span>
                {% endif %}
            {% else %}
                <div style="color: #999;">No data</div>
            {% endif %}
        </div>

        <div>
            <div style="color: #666; font-size: 0.9rem;">Lowest Price</div>
            {% if lowest_price %}
                <div class="price">₹{{ "{:,.0f}".format(lowest_price) }}</div>
                {% if latest_price and latest_price.price == lowest_price %}
                    <span class="badge badge-success">Current = Lowest!</span>
                {% endif %}
            {% else %}
                <div style="color: #999;">-</div>
            {% endif %}
        </div>

        <div>
            <div style="color: #666; font-size: 0.9rem;">Target Price</div>
            {% if product.target_price %}
                <div class="price">₹{{ "{:,.0f}".format(product.target_price) }}</div>
                {% if latest_price and latest_price.price <= product.target_price %}
                    <span class="badge badge-success">✓ Target Reached!</span>
                {% endif %}
            {% else %}
                <form method="POST" action="/target/{{ product.id }}" style="display: inline;">
                    <input type="number" name="target_price" placeholder="Set target" style="width: 120px; padding: 5px;" step="0.01">
                    <button type="submit" class="btn" style="padding: 5px 10px; font-size: 0.9rem;">Set</button>
                </form>
            {% endif %}
        </div>

        <div>
            <div style="color: #666; font-size: 0.9rem;">Source</div>
            <div class="badge badge-info" style="font-size: 1rem; padding: 8px 12px; margin-top: 5px;">
                {{ product.source }}
            </div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ product.url }}" target="_blank" class="btn" style="text-decoration: none;">View on {{ product.source }}</a>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 20px;">Price History</h3>

    {% if price_history_json and price_history_json|length > 0 %}
        <div style="position: relative; height: 300px; margin-bottom: 20px;">
            <canvas id="priceChart"></canvas>
        </div>

        <div style="margin-top: 30px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="text-align: left; padding: 10px;">Date</th>
                        <th style="text-align: right; padding: 10px;">Price</th>
                        <th style="text-align: right; padding: 10px;">MRP</th>
                        <th style="text-align: center; padding: 10px;">Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in price_history[:20] %}
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px;">{{ record.recorded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td style="text-align: right; padding: 10px; font-weight: 500; {% if record.price == lowest_price %}color: #38a169;{% endif %}">
                            ₹{{ "{:,.0f}".format(record.price) }}
                        </td>
                        <td style="text-align: right; padding: 10px; color: #999;">
                            {% if record.original_price %}₹{{ "{:,.0f}".format(record.original_price) }}{% else %}-{% endif %}
                        </td>
                        <td style="text-align: center; padding: 10px;">
                            {% if record.in_stock %}✓{% else %}✗{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 40px;">No price history yet.</p>
    {% endif %}
</div>

<script>
{% if price_history_json and price_history_json|length > 0 %}
try {
    const ctx = document.getElementById('priceChart').getContext('2d');

// Reverse to show oldest first
const data = {{ price_history_json | reverse | list | tojson }};

const labels = data.map(d => {
    const date = new Date(d.recorded_at);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
});

const prices = data.map(d => d.price);

new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Price (₹)',
            data: prices,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.1,
            fill: true,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '₹' + context.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: function(value) {
                        return '₹' + value.toLocaleString();
                    }
                }
            }
        }
    }
});
} catch (error) {
    console.error('Error creating chart:', error);
    document.getElementById('priceChart').remove();
}
{% endif %}
</script>
{% endblock %}
